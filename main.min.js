var __reflect=this&&this.__reflect||function(e,t,a){e.__class__=t,a?a.push(t):a=[t],e.__types__=e.__types__?a.concat(e.__types__):a},__extends=this&&this.__extends||function(e,t){function a(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)},__decorate=this&&this.__decorate||function(e,t,a,n){var r,o=arguments.length,i=3>o?t:null===n?n=Object.getOwnPropertyDescriptor(t,a):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,a,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(3>o?r(i):o>3?r(t,a,i):r(t,a))||i);return o>3&&i&&Object.defineProperty(t,a,i),i},__awaiter=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))(function(r,o){function i(e){try{h(n.next(e))}catch(t){o(t)}}function s(e){try{h(n["throw"](e))}catch(t){o(t)}}function h(e){e.done?r(e.value):new a(function(t){t(e.value)}).then(i,s)}h((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function a(e){return function(t){return n([e,t])}}function n(a){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(i=o[2&a[0]?"return":a[0]?"throw":"next"])&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[0,i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(i=s.trys,!(i=i.length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(n){a=[6,n],o=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}var r,o,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return{next:a(0),"throw":a(1),"return":a(2)}},DragonBonesModelEvent;!function(e){e[e.DragonBonesChange=100]="DragonBonesChange",e[e.ArmatureAdd=101]="ArmatureAdd",e[e.ArmatureRemove=102]="ArmatureRemove",e[e.ArmatureChange=103]="ArmatureChange",e[e.AnimationStart=104]="AnimationStart",e[e.AnimationComplete=105]="AnimationComplete",e[e.AnimationPlay=106]="AnimationPlay",e[e.AnimationStop=107]="AnimationStop",e[e.AnimationChange=108]="AnimationChange"}(DragonBonesModelEvent||(DragonBonesModelEvent={}));var DragonBonesModel=function(){function e(){this._armatureItems=[],this._armatures=[],this._armature=null,this._animation=null}return e.prototype._animationHandler=function(e){switch(e.type){case dragonBones.EventObject.FADE_IN:e.animationState&&(this._animation&&this._animation.name===e.animationState.name||(this._animation=e.animationState,this.dispatchEvent(DragonBonesModelEvent.AnimationChange,this._animation),this.dispatchEvent(DragonBonesModelEvent.AnimationPlay,this._animation)),this._animation=e.animationState,this.dispatchEvent(DragonBonesModelEvent.AnimationStart,this._animation));break;case dragonBones.EventObject.COMPLETE:this.dispatchEvent(DragonBonesModelEvent.AnimationComplete,this._animation)}},e.prototype.init=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.dispatchEvent=function(e,t){DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[e],!1,t)},e.prototype.addArmature=function(e,t){var a=dragonBones.EgretFactory.factory.buildArmatureDisplay(t,e);return null!==a?(this._armatures.push(a.armature),this.dispatchEvent(DragonBonesModelEvent.ArmatureAdd,a.armature),a.armature):null},e.prototype.removeArmature=function(e){this.armature===e&&(this.armature=null);var t=this._armatures.indexOf(e);t>=0&&(this._armatures.splice(t,1),this.dispatchEvent(DragonBonesModelEvent.ArmatureRemove,e),e.dispose())},e.prototype.clearAllArmature=function(){for(var e=this._armatures.length;e--;){var t=this._armatures[e];this.removeArmature(t)}},e.prototype.changeArmature=function(e){if(!(this._armatureItems.length>0)){this._armature&&this.removeArmature(this._armature),e%=this._armatureItems.length,0>e&&(e=this._armatureItems.length+e);var t=this._armatureItems[e];this.armature=this.addArmature(t.data,t.name),this.playAnimation()}},e.prototype.prevArmature=function(){if(this._armature){for(var e=0,t=0,a=this._armatureItems;t<a.length;t++){var n=a[t];if(this._armature.armatureData.parent.name===n.name||this._armature.armatureData.name)break;e++}this.changeArmature(e-1)}else this.changeArmature(0)},e.prototype.nextArmature=function(){if(this._armature){for(var e=0,t=0,a=this._armatureItems;t<a.length;t++){var n=a[t];if(this._armature.armatureData.parent.name===n.name||this._armature.armatureData.name)break;e++}this.changeArmature(e+1)}else this.changeArmature(0)},e.prototype.playAnimation=function(){this._armature&&(this._armature.animation.play(),this.dispatchEvent(DragonBonesModelEvent.AnimationPlay,this._animation))},e.prototype.stopAnimation=function(){this._armature&&(this._armature.animation.stop(),this.dispatchEvent(DragonBonesModelEvent.AnimationStop,this._animation))},e.prototype.changeAnimation=function(e){if(this._armature){var t=this._armature.armatureData.animationNames;e%=t.length,0>e&&(e+=t.length);var a=this._armature.animation.fadeIn(t[e],.001);a&&(a.resetToPose=!1)}},e.prototype.prevAnimation=function(){if(this._armature)if(this._animation){var e=this._armature.armatureData.animationNames;this.changeAnimation(e.indexOf(this._animation.name)-1)}else this._armature.animation.play()},e.prototype.nextAnimation=function(){if(this._armature)if(this._animation){var e=this._armature.armatureData.animationNames;this.changeAnimation(e.indexOf(this._animation.name)+1)}else this._armature.animation.play()},Object.defineProperty(e.prototype,"armatures",{get:function(){return this._armatures},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"armature",{get:function(){return this._armature},set:function(e){this._armature!==e&&(this._animation=null,this.dispatchEvent(DragonBonesModelEvent.AnimationChange,null),this._armature&&(this._armature.removeEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.removeEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),this._armature=e,this._armature&&(this._armature.addEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.addEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),this.dispatchEvent(DragonBonesModelEvent.ArmatureChange,this._armature))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),e}();__reflect(DragonBonesModel.prototype,"DragonBonesModel");var DragonBonesControl=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.getInstance=function(){return t._instance||(t._instance=new egret.EventDispatcher),t._instance},t}(egret.EventDispatcher);__reflect(DragonBonesControl.prototype,"DragonBonesControl");var Main=function(e){function t(){var t=e.call(this)||this;return t.model=new MainModel,t.view=new MainView,t.addEventListener(egret.Event.ADDED_TO_STAGE,t._addToStageHandler,t),t.addChild(t.view),t}return __extends(t,e),t.prototype._addToStageHandler=function(){var e=this;RES.loadConfig().then(function(){RES.loadGroup("preload").then(function(){e.view.init(e.model),e.model.init(RES.getRes("resource_config_json"),RES.getRes("game_config_json")),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.Startup])})})},t}(egret.DisplayObjectContainer);Main=__decorate([RES.mapConfig("config.json",function(){return"resource"},function(e){var t=e.substr(e.lastIndexOf(".")+1),a={jpg:"image",png:"image",webp:"image",json:"json",fnt:"font",pvr:"pvr",mp3:"sound"},n=a[t];return"json"==n&&(e.indexOf("sheet")>=0?n="sheet":e.indexOf("movieclip")>=0&&(n="movieclip")),n})],Main),__reflect(Main.prototype,"Main");var DragonBonesModelEvent;!function(e){e[e.ChangePlayer=200]="ChangePlayer",e[e.AddPlayer=201]="AddPlayer",e[e.RemovePlayer=202]="RemovePlayer",e[e.ChangeClothes=203]="ChangeClothes",e[e.ChangeMovement=204]="ChangeMovement",e[e.Startup=205]="Startup"}(DragonBonesModelEvent||(DragonBonesModelEvent={}));var PlayerModel=function(){function e(){this.clothes=[]}return e}();__reflect(PlayerModel.prototype,"PlayerModel",["IName"]);var MainModel=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.player=new PlayerModel,t}return __extends(t,e),t.prototype.findItemFromArray=function(e,t){for(var a=0,n=t;a<n.length;a++){var r=n[a];if(r.name===e)return r}return null},t.prototype.init=function(t,a){e.prototype.init.call(this),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.AnimationComplete],this._modelHandler,this),this.resourceConfig=t,this.gameConfig=a,this.gameConfig.players.length>0?this.changePlayer(this.gameConfig.players[0]):this.createPlayer(this.resourceConfig.roles[0])},t.prototype._modelHandler=function(e){switch(e.type){case DragonBonesModelEvent[DragonBonesModelEvent.AnimationComplete]:this.changeMovement(this.player.role)}},t.prototype.createPlayer=function(e){var t={name:"unnamed",role:e.name,clothes:e.clothes.concat()};this.addPlayer(t),this.changePlayer(t)},t.prototype.changePlayer=function(e){this.player.config=e,this.player.name=e.name,this.player.role=this.findItemFromArray(e.role,this.resourceConfig.roles),this.player.clothes.length=0;for(var t=0,a=this.player.config.clothes;t<a.length;t++){var n=a[t],r=this.findItemFromArray(n,this.resourceConfig.clothes);r&&this.player.clothes.push(r)}this.changeMovement(this.player.role),this.dispatchEvent(DragonBonesModelEvent.ChangePlayer,this.player)},t.prototype.addPlayer=function(e){var t=this.gameConfig.players.indexOf(e);t>=0||(this.gameConfig.players.push(e),this.dispatchEvent(DragonBonesModelEvent.AddPlayer,e))},t.prototype.removePlayer=function(e){var t=this.gameConfig.players.indexOf(e);0>t||(this.gameConfig.players.splice(t,1),this.dispatchEvent(DragonBonesModelEvent.RemovePlayer,e),this.gameConfig.players.length>0?this.changePlayer(this.gameConfig.players[0]):this.createPlayer(this.resourceConfig.roles[0]))},t.prototype.getCloth=function(e){return this.findItemFromArray(e,this.resourceConfig.clothes)},t.prototype.addSuit=function(e){for(var t=0,a=e.clothes;t<a.length;t++){var n=a[t],r=this.getCloth(n);this.addCloth(r)}},t.prototype.getCurrentSuit=function(){for(var e=0,t=this.resourceConfig.suits;e<t.length;e++){var a=t[e];if(this.player.config.clothes.length===a.clothes.length){var n=!0;for(var r in this.player.clothes)if(a.clothes.indexOf(r)<0){n=!1;break}if(n)return a}}return null},t.prototype.addCloth=function(e){if(e&&!(this.player.clothes.indexOf(e)>=0)){this.player.config.clothes.length=0;for(var t=this.player.clothes.length;t--;){for(var a=this.player.clothes[t],n=!1,r=0,o=e.types;r<o.length;r++){var i=o[r];if(a.types.indexOf(i)>=0){n=!0;break}}n?this.player.clothes.splice(t,1):this.player.config.clothes.push(a.name)}this.player.clothes.push(e),this.player.config.clothes.push(e.name),this.updateClothes()}},t.prototype.removeCloth=function(e){if(e&&!(this.player.clothes.indexOf(e)<0)){this.player.config.clothes.length=0;for(var t=this.player.clothes.length;t--;){var a=this.player.clothes[t];a===e?this.player.clothes.splice(t,1):this.player.config.clothes.push(a.name)}this.updateClothes()}},t.prototype.updateClothes=function(){return __awaiter(this,void 0,void 0,function(){var e,t,a;return __generator(this,function(n){switch(n.label){case 0:dragonBones.EgretFactory.factory.changeSkin(this._armature,this.player.role.armature,this.player.role.data),e=0,t=this.player.clothes,n.label=1;case 1:return e<t.length?(a=t[e],dragonBones.EgretFactory.factory.getDragonBonesData(a.data)?[3,5]:[4,RES.getResAsync("assets/"+a.data+"_ske.json")]):[3,7];case 2:return n.sent(),[4,RES.getResAsync("assets/"+a.data+"_tex.json")];case 3:return n.sent(),[4,RES.getResAsync("assets/"+a.data+"_tex.png")];case 4:n.sent(),dragonBones.EgretFactory.factory.parseDragonBonesData(RES.getRes("assets/"+a.data+"_ske.json")),dragonBones.EgretFactory.factory.parseTextureAtlasData(RES.getRes("assets/"+a.data+"_tex.json"),RES.getRes("assets/"+a.data+"_tex.png")),n.label=5;case 5:dragonBones.EgretFactory.factory.changeSkin(this._armature,a.armature,a.data),n.label=6;case 6:return e++,[3,1];case 7:return this._armature&&this._armature.invalidUpdate(),this.dispatchEvent(DragonBonesModelEvent.ChangeClothes,this.player),[2]}})})},t.prototype.changeMovement=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.movement===e?[2]:this.movement&&this.movement.data===e.data&&this.movement.armature===e.armature?[3,5]:dragonBones.EgretFactory.factory.getDragonBonesData(e.data)?[3,4]:[4,RES.getResAsync("assets/"+e.data+"_ske.json")];case 1:return t.sent(),[4,RES.getResAsync("assets/"+e.data+"_tex.json")];case 2:return t.sent(),[4,RES.getResAsync("assets/"+e.data+"_tex.png")];case 3:t.sent(),dragonBones.EgretFactory.factory.parseDragonBonesData(RES.getRes("assets/"+e.data+"_ske.json")),dragonBones.EgretFactory.factory.parseTextureAtlasData(RES.getRes("assets/"+e.data+"_tex.json"),RES.getRes("assets/"+e.data+"_tex.png")),t.label=4;case 4:this.armature&&this.removeArmature(this.armature),this.armature=this.addArmature(e.data,e.armature),t.label=5;case 5:return this.movement=e,this.armature&&this.changeAnimation(this.armature.animation.animationNames.indexOf(this.movement.animations[0].animation)),this.updateClothes(),this.dispatchEvent(DragonBonesModelEvent.ChangeMovement,this.movement),[2]}})})},t}(DragonBonesModel);__reflect(MainModel.prototype,"MainModel");var MainView=function(e){function t(){var t=e.call(this)||this;return t._viewStage=new egret.DisplayObjectContainer,t._armatureContainer=new egret.DisplayObjectContainer,t._viewStage.addChild(t._armatureContainer),t.addChild(t._viewStage),t}return __extends(t,e),t.prototype._modelEventHandler=function(e){switch(e.type){case DragonBonesModelEvent[DragonBonesModelEvent.Startup]:this._clothesInit(),this._movementInit();break;case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureAdd]:var t=e.data;this._armatureContainer.addChild(t.display);break;case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove]:var t=e.data;this._armatureContainer.removeChild(t.display);break;case DragonBonesModelEvent[DragonBonesModelEvent.ChangeClothes]:for(var a=0,n=this._model.resourceConfig.clothes.length;n>a;++a){var r=this._panelClothes.armature.getSlot("button_"+a);r&&r.childArmature&&(this._model.player.clothes.indexOf(r.userData)>=0?r.childArmature.animation.fadeIn("selected",.2):r.childArmature.animation.fadeIn("normal",.2))}break;case DragonBonesModelEvent[DragonBonesModelEvent.ChangeMovement]:}},t.prototype._clothesInit=function(){return __awaiter(this,void 0,void 0,function(){var e,t,a,n,r,o,i=this;return __generator(this,function(s){switch(s.label){case 0:this._panelClothes.touchEnabled=!0,this._panelClothes.x=this.stage.stageWidth-210,this._panelClothes.y=10,this._panelClothes.addEventListener("touchEnd",function(e){var t=i._panelClothes.armature.getSlotByDisplay(e.target);t&&(i._model.player.clothes.indexOf(t.userData)>=0?i._model.removeCloth(t.userData):i._model.addCloth(t.userData))},this),e=0,t=this._model.resourceConfig.clothes.length,s.label=1;case 1:return t>e?(a=this._model.resourceConfig.clothes[e],(n=this._panelClothes.armature.getSlot("button_"+e))?(n.userData=a,n.childArmature?(n.childArmature.display.touchEnabled=!0,(r=n.childArmature.getSlot("image"))?(o=r.display=new egret.Bitmap,[4,RES.getResAsync("icon/"+a.name+".png")]):[3,3]):[3,3]):[3,3]):[3,4];case 2:s.sent(),o.texture=RES.getRes("icon/"+a.name+".png"),o.anchorOffsetX=48,o.anchorOffsetY=48,o.width=96,o.height=96,s.label=3;case 3:return++e,[3,1];case 4:return this.addChild(this._panelClothes),[2]}})})},t.prototype._movementInit=function(){return __awaiter(this,void 0,void 0,function(){var e,t,a,n,r,o,i=this;return __generator(this,function(s){switch(s.label){case 0:this._panelMovement.touchEnabled=!0,this._panelMovement.addEventListener("touchEnd",function(e){var t=i._panelMovement.armature.getSlotByDisplay(e.target);t&&i._model.changeMovement(t.userData)},this),e=0,t=this._model.resourceConfig.movements.length,s.label=1;case 1:return t>e?(a=this._model.resourceConfig.movements[e],(n=this._panelMovement.armature.getSlot("button_"+e))?(n.userData=a,n.childArmature?(n.childArmature.display.touchEnabled=!0,(r=n.childArmature.getSlot("image"))?(o=r.display=new egret.Bitmap,[4,RES.getResAsync("icon/"+a.name+".png")]):[3,3]):[3,3]):[3,3]):[3,4];case 2:s.sent(),o.texture=RES.getRes("icon/"+a.name+".png"),o.anchorOffsetX=48,o.anchorOffsetY=48,o.width=96,o.height=96,s.label=3;case 3:return++e,[3,1];case 4:return this.addChild(this._panelMovement),[2]}})})},t.prototype._onResize=function(){this._armatureContainer.x=300,this._armatureContainer.y=this.stage.stageHeight-200,this._armatureContainer.scaleX=this._armatureContainer.scaleY=.9,this._panelMovement.x=.5*this.stage.stageWidth,this._panelMovement.y=this.stage.stageHeight-110},t.prototype.init=function(e){var t=this;dragonBones.EgretFactory.factory.parseDragonBonesData(RES.getRes("ui_ske_json")),dragonBones.EgretFactory.factory.parseTextureAtlasData(RES.getRes("ui_tex_json"),RES.getRes("ui_tex_png")),this._model=e,this._panelMovement=dragonBones.EgretFactory.factory.buildArmatureDisplay("panel_movement"),this._panelClothes=dragonBones.EgretFactory.factory.buildArmatureDisplay("panel_clothes"),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.Startup],this._modelEventHandler,this),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureAdd],this._modelEventHandler,this),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove],this._modelEventHandler,this),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ChangeClothes],this._modelEventHandler,this),this.stage.addEventListener(egret.Event.RESIZE,function(){t._onResize()},this),this._onResize()},t}(egret.DisplayObjectContainer);__reflect(MainView.prototype,"MainView");